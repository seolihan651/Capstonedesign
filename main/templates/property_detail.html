{% extends 'layout.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/property_detail.css' %}">
<link rel="stylesheet" href="{% static 'css/tender.css' %}">
<!-- Add Naver Maps API script -->
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId={{ naver_maps_client_id }}&callback=initMap"></script>
{% endblock %}

{% block content %}
<div class="container property-detail-container">
  <h1>ë§¤ë¬¼ ìƒì„¸ ì •ë³´ (ID: {{ property_id }})</h1>

  <div class="detail-grid">
    <div class="detail-grid-left">
      <section class="photo-section card">
        <h2>ì‚¬ì§„</h2>
        <div class="left-section">
          <div class="main-image-container">
            <button class="arrow left" onclick="prevImage()">&#10094;</button>
            <img id="mainImage" src="{% if main_image_url %}{{ main_image_url }}{% else %}{% static 'img/ex/01.png' %}{% endif %}" alt="ë©”ì¸ ì´ë¯¸ì§€" />
            <button class="arrow right" onclick="nextImage()">&#10095;</button>
            <div id="image-counter">1 / {{ image_paths|length|default:1 }}</div>
          </div>
          <div class="thumbnail-row">
            {% for image_path in image_paths %}
              <img src="{{ image_path }}" class="thumb" onclick="setMainImage({{ forloop.counter0 }})" />
            {% empty %}
              <!-- Default static thumbnails if dynamic ones aren't provided -->
              <img src="{% static 'img/ex/01.png' %}" class="thumb" onclick="setMainImage(0)" />
              <img src="{% static 'img/ex/02.png' %}" class="thumb" onclick="setMainImage(1)" />
            {% endfor %}
          </div>
        </div>
      </section>

      <section class="map-section card">
        <h2>ìœ„ì¹˜ ì •ë³´ (ì§€ë„)</h2>
        <div id="map" style="width:100%;height:400px;"></div>
      </section>
    </div>

    <div class="detail-grid-right">
      <section class="info-table-section card">
        <h2>ê¸°ë³¸ ì •ë³´</h2>
        <table class="detail-table">
          <tr><th>ì‚¬ê±´ë²ˆí˜¸</th><td>{{ property_info.case_number|default:"-" }}</td><th>ì‚¬ê±´ëª…</th><td>{{ property_info.case_name|default:"-" }}</td></tr>
          <tr><th>ë²•ì›</th><td>{{ property_info.court|default:"-" }}</td><th>ì ‘ìˆ˜ì¼ì</th><td>{{ property_info.receipt_date|date:"Y/m/d"|default:"-" }}</td></tr>
          <tr><th>ë‹´ë‹¹ê³„</th><td>{{ property_info.responsible_dept|default:"-" }}</td><th>ì²­êµ¬ê¸ˆì•¡</th><td>{{ property_info.claim_amount|default:"-" }}</td></tr>
          <tr><th>í•­ê³ ì—¬ë¶€</th><td>{{ property_info.appeal_status_display|default:"-" }}</td><th>ìµœì €ì…ì°°ê°€</th><td>{{ property_info.min_bid_price|default:"-" }}</td></tr>
        </table>
      </section>

      <section class="info-table-section card">
        <h2>ì†Œì¬ì§€ ì •ë³´</h2>
        <table class="detail-table">
          <tr><th>ì†Œì¬ì§€</th><td colspan="3">{{ location_info.address|default:"-" }}</td></tr>
          <tr><th>ë°°ë‹¹ìš”êµ¬ì¢…ê¸°ì¼</th><td>{{ location_info.claim_end_date|date:"Y/m/d"|default:"-" }}</td><th>ì‚¬ê±´ë²ˆí˜¸</th><td>{{ location_info.case_number|default:"-" }}</td></tr>
        </table>
      </section>
      
      <section class="specification-section card">
        <h2>ë§¤ë¬¼ ê´€ë ¨ ìƒì„¸ ëª…ì„¸ì„œ</h2>
        <div class="spec-documents">
          <div class="spec-document-card">
            <div class="document-icon">ğŸ“‹</div>
            <h3>ë§¤ê°ë¬¼ê±´ëª…ì„¸ì„œ</h3>
            <p>ë§¤ê°ë¬¼ê±´ì˜ ê¸°ë³¸ ì •ë³´ì™€ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <a href="{{ document_urls.specification_url|default:'#' }}" onclick="window.open(this.href, '_blank'); return false;" class="btn-spec">
              <i class="fas fa-file-alt"></i> ëª…ì„¸ì„œ ë³´ê¸°
            </a>
          </div>

          <div class="spec-document-card">
            <div class="document-icon">ğŸ”</div>
            <h3>í˜„í™©ì¡°ì‚¬ì„œ</h3>
            <p>ë§¤ê°ë¬¼ê±´ì˜ í˜„ì¬ ìƒíƒœì™€ ì£¼ë³€ í™˜ê²½ì— ëŒ€í•œ ì¡°ì‚¬ ë‚´ìš©ì…ë‹ˆë‹¤.</p>
            <a href="{{ document_urls.status_report_url|default:'#' }}" onclick="window.open(this.href, '_blank'); return false;" class="btn-spec">
              <i class="fas fa-search"></i> ì¡°ì‚¬ì„œ ë³´ê¸°
            </a>
          </div>

          <div class="spec-document-card">
            <div class="document-icon">ğŸ’°</div>
            <h3>ê°ì •í‰ê°€ì„œ</h3>
            <p>ì „ë¬¸ ê°ì •í‰ê°€ê¸°ê´€ì˜ ë¬¼ê±´ ê°€ì¹˜ í‰ê°€ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
            <a href="{{ document_urls.appraisal_url|default:'#' }}" onclick="window.open(this.href, '_blank'); return false;" class="btn-spec">
              <i class="fas fa-chart-line"></i> í‰ê°€ì„œ ë³´ê¸°
            </a>
          </div>
        </div>
      </section>
    </div>
  </div>

  <section class="info-table-section card">
    <h2>ì…ì°° ë‚´ì—­ í˜„í™©</h2>
    <div class="table-responsive">
      <table class="detail-table full-width-table">
        <thead>
          <tr>
            <th>ë²ˆí˜¸</th><th>ë‚´ìš©</th><th>êµ¬ë¶„</th><th>ìµœì €ê°€</th><th>ê²°ê³¼</th>
            <th>ê°ì •ê°€/ìµœì €ê°€/ë³´ì¦ê¸ˆ(10%)</th>
            <th>ë§¤ê°ê¸°ì¼</th><th>ì”ê¸ˆê¸°ì¼</th>
          </tr>
        </thead>
        <tbody>
          {% for item in bidding_history %}
          <tr>
            <td>{{ item.id|default:forloop.counter }}</td>
            <td><a href="{{ item.url|default:'#' }}">{{ item.link_text|default:"-" }}</a></td>
            <td>{{ item.type|default:"-" }}</td>
            <td>{{ item.min_price|default:"-" }}</td>
            <td>{{ item.status|default:"-" }}</td>
            <td>{{ item.price_details|default:"-" }}</td>
            <td>{{ item.auction_date|date:"Y/m/d (H:i)"|default:"-" }}</td>
            <td>{{ item.due_date|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="8">ì…ì°° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="info-table-section card">
    <h2>ê±´ë¬¼ ìƒì„¸ ë° í˜„í™©</h2>
    <div class="table-responsive">
      <table class="detail-table full-width-table">
        <thead>
          <tr><th>ëª©ë¡êµ¬ë¶„</th><th>ìƒì„¸ë‚´ì—­</th><th>ë¹„ê³ </th><th>ì‚¬ê±´ë²ˆí˜¸</th></tr>
        </thead>
        <tbody>
          {% for item in building_details %}
          <tr>
            <td>{{ item.category|default:"-" }}</td>
            <td style="white-space: pre-line;">{{ item.description|default:"-" }}</td>
            <td>{{ item.remarks|default:"-" }}</td>
            <td>{{ item.case_number|default:"-" }}</td>
          </tr>
          {% empty %}
            <tr><td colspan="4">ê±´ë¬¼ ìƒì„¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="info-table-section card">
    <h2>ë“±ê¸° í˜„í™© ë° ê¶Œë¦¬ê´€ê³„ (ë‹¹ì‚¬ì ì •ë³´)</h2>
    <div class="table-responsive">
      <table class="detail-table full-width-table">
        <thead>
          <tr><th>ë‹¹ì‚¬ìêµ¬ë¶„</th><th>ë‹¹ì‚¬ìëª…</th><th>ì‚¬ê±´ë²ˆí˜¸</th><th>ë¹„ê³ </th></tr>
        </thead>
        <tbody>
          {% for item in interested_parties %}
          <tr>
            <td>{{ item.type|default:"-" }}</td>
            <td>{{ item.name|default:"-" }}</td>
            <td>{{ item.case_number|default:"-" }}</td>
            <td>{{ item.remarks|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">ë‹¹ì‚¬ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</div>

<script>
function initMap() {
    var mapOptions = {
        center: new naver.maps.LatLng({{ map_latitude|default:"37.5665" }}, {{ map_longitude|default:"126.9780" }}),
        zoom: 15
    };

    var map = new naver.maps.Map('map', mapOptions);

    var marker = new naver.maps.Marker({
        position: new naver.maps.LatLng({{ map_latitude|default:"37.5665" }}, {{ map_longitude|default:"126.9780" }}),
        map: map
    });
}

document.addEventListener("DOMContentLoaded", function () {
    let imagePaths = [
        {% for image_path in image_paths %}
            "{{ image_path }}",
        {% empty %}
            "{% static 'img/ex/01.png' %}",
            "{% static 'img/ex/02.png' %}",
            "{% static 'img/ex/03.png' %}",
            "{% static 'img/ex/04.png' %}",
            "{% static 'img/ex/05.png' %}"
        {% endfor %}
    ];
    // Remove trailing comma if imagePaths was populated dynamically
    if (imagePaths.length > 0 && imagePaths[imagePaths.length-1] === "") {
        imagePaths.pop();
    }
    if (imagePaths.length > 0 && imagePaths[imagePaths.length-1].endsWith(",")) {
        imagePaths[imagePaths.length-1] = imagePaths[imagePaths.length-1].slice(0, -1);
    }

    let currentIndex = 0;
    const mainImageEl = document.getElementById("mainImage");
    const imageCounter = document.getElementById("image-counter");

    function updateImage() {
        if (mainImageEl && imagePaths.length > 0) {
            mainImageEl.src = imagePaths[currentIndex];
            if (imageCounter) {
                imageCounter.textContent = `${currentIndex + 1} / ${imagePaths.length}`;
            }
        }
    }

    window.setMainImage = function(index) {
        if (index >= 0 && index < imagePaths.length) {
            currentIndex = index;
            updateImage();
        }
    }

    window.prevImage = function() {
        currentIndex = (currentIndex - 1 + imagePaths.length) % imagePaths.length;
        updateImage();
    }

    window.nextImage = function() {
        currentIndex = (currentIndex + 1) % imagePaths.length;
        updateImage();
    }

    if (mainImageEl && imagePaths.length > 0) {
        updateImage(); 
    } else if (mainImageEl) {
        if(imageCounter) imageCounter.style.display = 'none';
    }
});
</script>
{% endblock %} 